name: protein-binder-dashboard-default

# Default dashboard stack:
# - Starts MCP Server + Dashboard immediately
# - Background-downloads required weights and AlphaFold reduced DBs into /models
# - If embedded provisioning fails, users can point External/NIM URLs in the dashboard
#
# Start from repo root:
#   docker compose -f deploy/docker-compose-dashboard-default.yaml up -d --build

services:
  mcp-server:
    image: ${MCP_SERVER_IMAGE:-mcp-server:local}
    build:
      context: ../mcp-server
      dockerfile: Dockerfile
    ports:
      - "${MCP_SERVER_HOST_PORT:-8011}:8000"
    volumes:
      - mcp-config:/config
      - mcp-models:/models
    environment:
      - MCP_CONFIG_PATH=/config/mcp_config.json

      # Prefer embedded downloads, then fall back to user-configured External/NIM.
      - MCP_ROUTING_MODE=${MCP_ROUTING_MODE:-fallback}
      - MCP_ROUTING_ORDER=${MCP_ROUTING_ORDER:-embedded,nim,external}

      # Enable non-blocking background provisioning.
      - MCP_EMBEDDED_AUTO_DOWNLOAD=${MCP_EMBEDDED_AUTO_DOWNLOAD:-1}
      - MCP_BOOTSTRAP_ON_STARTUP=${MCP_BOOTSTRAP_ON_STARTUP:-1}

      # Built-in download presets (no custom URLs required).
      - MCP_ALPHAFOLD_DB_PRESET=${MCP_ALPHAFOLD_DB_PRESET:-reduced_dbs}
      - MCP_RFDIFFUSION_DEFAULT_WEIGHTS=${MCP_RFDIFFUSION_DEFAULT_WEIGHTS:-1}
      - MCP_PROTEINMPNN_DEFAULT_WEIGHTS=${MCP_PROTEINMPNN_DEFAULT_WEIGHTS:-1}

      # AlphaFold Performance Optimizations (29% speedup)
      # Speed preset: fast (29% faster), balanced (20% faster), quality (slowest)
      - ALPHAFOLD_SPEED_PRESET=${ALPHAFOLD_SPEED_PRESET:-balanced}
      - ALPHAFOLD_MSA_MODE=${ALPHAFOLD_MSA_MODE:-mmseqs2}
      - ALPHAFOLD_MMSEQS2_MAX_SEQS=${ALPHAFOLD_MMSEQS2_MAX_SEQS:-512}
      - ALPHAFOLD_NUM_RECYCLES=${ALPHAFOLD_NUM_RECYCLES:-3}
      - ALPHAFOLD_USE_GPU_RELAX=${ALPHAFOLD_USE_GPU_RELAX:-auto}
      
      # CPU Thread Pinning (prevents oversubscription)
      - OMP_NUM_THREADS=${OMP_NUM_THREADS:-16}
      - TF_NUM_INTRAOP_THREADS=${TF_NUM_INTRAOP_THREADS:-16}
      - TF_NUM_INTEROP_THREADS=${TF_NUM_INTEROP_THREADS:-1}

      # Optional: explicitly disable local NIM defaults inside the MCP container.
      # Users can still set NIM endpoints from the dashboard.
      - ALPHAFOLD_URL=${ALPHAFOLD_URL:-disabled}
      - RFDIFFUSION_URL=${RFDIFFUSION_URL:-disabled}
      - PROTEINMPNN_URL=${PROTEINMPNN_URL:-disabled}
      - ALPHAFOLD_MULTIMER_URL=${ALPHAFOLD_MULTIMER_URL:-disabled}
    restart: unless-stopped

  mcp-dashboard:
    image: ${MCP_DASHBOARD_IMAGE:-mcp-dashboard:local}
    build:
      context: ../mcp-dashboard
      dockerfile: Dockerfile
    ports:
      - "${MCP_DASHBOARD_HOST_PORT:-3000}:3000"
    environment:
      - MCP_SERVER_URL=http://mcp-server:8000
      - NEXT_PUBLIC_MCP_SERVER_URL=http://mcp-server:8000
    depends_on:
      - mcp-server

volumes:
  mcp-config:
  mcp-models:
